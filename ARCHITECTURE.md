# 🏗️ Kimi-Mem 架构图解

## 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              👤 用户层                                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐               │
│  │  💬 Kimi CLI    │  │  🌐 Web UI      │  │  📱 MCP 客户端   │               │
│  │  /flow:kimi-mem │  │ localhost:37777 │  │  Obsidian 等    │               │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘               │
└───────────┼────────────────────┼────────────────────┼────────────────────────┘
            │                    │                    │
            ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           🎯 核心处理层                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     🧠 Kimi-Mem Core                                │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │    │
│  │  │ 📸 Capture   │  │ 💾 Storage   │  │ 🔍 Search    │              │    │
│  │  │   自动捕获   │  │   存储管理   │  │   搜索服务   │              │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
            │                    │                    │
            ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           💾 数据存储层                                       │
│                                                                             │
│   ┌─────────────────────┐      ┌─────────────────────┐                     │
│   │   🗄️ SQLite         │      │   📝 Markdown       │                     │
│   │   ─────────────     │      │   ─────────────     │                     │
│   │   memory.db         │      │   ~/kimi-mem-vault/ │                     │
│   │                     │      │                     │                     │
│   │  ┌─────────────┐    │      │  📁 sessions/       │                     │
│   │  │ sessions    │    │      │  📁 memories/       │                     │
│   │  ├─────────────┤    │      │  📄 index.md        │                     │
│   │  │ observations│    │      │                     │                     │
│   │  ├─────────────┤    │      └──────────┬──────────┘                     │
│   │  │ memories    │    │                 │                                  │
│   │  ├─────────────┤    │                 ▼                                  │
│   │  │ FTS5 索引   │    │      ┌─────────────────────┐                     │
│   │  └─────────────┘    │      │  🔮 Obsidian Vault  │                     │
│   └─────────────────────┘      │  (via MCP)          │                     │
│                                └─────────────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 数据流向图

### 🔄 自动捕获流程

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   用户操作    │────▶│  中间件拦截   │────▶│  数据格式化   │────▶│  存储分发     │
└──────────────┘     └──────────────┘     └──────────────┘     └──────┬───────┘
                                                                     │
                    ┌────────────────────────────────────────────────┘
                    │
                    ▼
        ┌─────────────────────┐
        │   💾 同时写入        │
        │  ┌───────────────┐  │
        │  │ SQLite (结构化) │  │
        │  └───────────────┘  │
        │  ┌───────────────┐  │
        │  │ Markdown (可读) │  │
        │  └───────────────┘  │
        │  ┌───────────────┐  │
        │  │ Obsidian (同步) │  │
        │  └───────────────┘  │
        └─────────────────────┘
```

---

## 存储架构详解

### 🗄️ SQLite 数据库结构

```
┌─────────────────────────────────────────────────────────────────┐
│                     memory.db                                    │
├─────────────────────────────────────────────────────────────────┤
│  📋 sessions 表                                                  │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐      │
│  │ id (PK)     │ start_time  │ project_path│ summary     │      │
│  │ TEXT        │ TEXT        │ TEXT        │ TEXT        │      │
│  └─────────────┴─────────────┴─────────────┴─────────────┘      │
├─────────────────────────────────────────────────────────────────┤
│  👁️ observations 表                                              │
│  ┌─────────┬──────────┬──────────┬──────────┬────────────────┐   │
│  │ id (PK) │ session  │ timestamp│ type     │ tool_name      │   │
│  │ INTEGER │ TEXT(FK) │ TEXT     │ TEXT     │ TEXT           │   │
│  ├─────────┼──────────┼──────────┼──────────┼────────────────┤   │
│  │ input   │ output   │ file_path│ metadata │ content_hash   │   │
│  │ TEXT    │ TEXT     │ TEXT     │ TEXT     │ TEXT           │   │
│  └─────────┴──────────┴──────────┴──────────┴────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  📝 memories 表                                                  │
│  ┌─────────┬──────────┬──────────┬──────────┬──────────────┐     │
│  │ id (PK) │ session  │ timestamp│ title    │ content      │     │
│  │ INTEGER │ TEXT(FK) │ TEXT     │ TEXT     │ TEXT         │     │
│  ├─────────┴──────────┼──────────┴──────────┴──────────────┤     │
│  │ tags (JSON)        │ category                           │     │
│  │ TEXT               │ TEXT                               │     │
│  └────────────────────┴────────────────────────────────────┘     │
├─────────────────────────────────────────────────────────────────┤
│  🔍 FTS5 虚拟表 (全文搜索)                                        │
│  • observations_fts: input_data + output_data                   │
│  • memories_fts: title + content                                │
└─────────────────────────────────────────────────────────────────┘
```

### 📝 Markdown Vault 结构

```
~/kimi-mem-vault/
│
├── 📄 index.md                    # 自动生成的索引
│
├── 📁 sessions/                   # 会话记录
│   └── 📁 2025/
│       └── 📁 02/
│           └── 📄 21-session-abc.md
│               # 会话记录 2025-02-21 10:30
│               # 
│               # **会话 ID**: `uuid`
│               # **项目路径**: `/path/to/project`
│               # 
│               # ## 详细记录
│               # 
│               # ### 2025-02-21T10:30:00 | user_input
│               # ...
│
└── 📁 memories/                   # 手动记忆
    ├── 📁 general/               # 一般记忆
    ├── 📁 bugfix/                # Bug 修复
    ├── 📁 feature/               # 功能开发
    ├── 📁 decision/              # 重要决策
    └── 📁 learning/              # 学习笔记
        └── 📄 Python-装饰器.md
            # # Python 装饰器
            # 
            # **时间**: 2025-02-21 10:30
            # **分类**: learning
            # 
            # ---
            # 
            # 内容...
```

---

## MCP 工具架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      🌐 MCP Server                               │
│                     Port: Stdio                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  📋 工具列表                                              │    │
│  │                                                          │    │
│  │  1️⃣ mem_search    ──────┐                               │    │
│  │     搜索索引            │                               │    │
│  │     ~50 tokens/结果     │                               │    │
│  │                         ▼                               │    │
│  │  2️⃣ mem_timeline  ────┐ │                               │    │
│  │     时间线上下文      │ │ 渐进式披露                     │    │
│  │     ~100 tokens       │ │                               │    │
│  │                       │ ▼                               │    │
│  │  3️⃣ mem_get       ────┴──▶ 完整详情                     │    │
│  │     批量获取            ~500-1000 tokens/条             │    │
│  │                                                          │    │
│  │  4️⃣ mem_save      ─────▶ 手动保存                       │    │
│  │                                                          │    │
│  │  5️⃣ mem_stats     ─────▶ 统计信息                       │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ Stdio
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    🤖 Kimi Code CLI                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 渐进式披露工作流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          🎯 渐进式披露 (Progressive Disclosure)               │
│                              节省 10 倍 Token                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Step 1: 搜索索引 (低成本)                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  mem_search(query="认证错误", limit=10)                              │   │
│  │                                                                     │   │
│  │  返回: 紧凑的索引列表                                                  │   │
│  │  • ID:123 | 2025-02-21 | tool_use | Shell                           │   │
│  │  • ID:124 | 2025-02-21 | file_op  | N/A                             │   │
│  │  • ID:125 | 2025-02-20 | manual  | API 认证                          │   │
│  │                                                                     │   │
│  │  成本: ~50 tokens × 10 = 500 tokens                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  Step 2: 时间线上下文 (中等成本)                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  mem_timeline(observation_id=123, window_minutes=10)                │   │
│  │                                                                     │   │
│  │  返回: 指定记录前后的操作                                              │   │
│  │  • 10:25 | user_input: 运行测试                                       │   │
│  │  • 10:28 | ReadFile: 查看配置文件                                     │   │
│  │  • 👉 10:30 | Shell: pip install (当前记录)                          │   │
│  │  • 10:32 | Shell: 报错信息                                            │   │
│  │  • 10:35 | ai_response: 解决方案                                      │   │
│  │                                                                     │   │
│  │  成本: ~100 tokens                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  Step 3: 完整详情 (高成本，仅筛选后)                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  mem_get(ids=[123, 132], type="observations")                       │   │
│  │                                                                     │   │
│  │  返回: 完整的命令输入和输出                                            │   │
│  │  ## 观察记录 #123                                                    │   │
│  │  **命令**: pip install requests                                      │   │
│  │  **输出**:                                                           │   │
│  │  ```                                                                │   │
│  │  ERROR: Could not find ...                                          │   │
│  │  详细错误信息 (可能 1000+ tokens)                                      │   │
│  │  ```                                                                │   │
│  │                                                                     │   │
│  │  成本: ~800 tokens × 2 = 1600 tokens                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  💡 总成本: 500 + 100 + 1600 = 2200 tokens                                  │
│  ❌ 传统方式 (直接获取 10 条详情): 800 × 10 = 8000 tokens                   │
│  ✅ 节省: 8000 - 2200 = 5800 tokens (约 72%)                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Web UI 架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          🌐 Web UI (localhost:37777)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  📊 Header Stats                                                    │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐               │   │
│  │  │ Sessions │ │   Obs    │ │ Memories │ │  Today   │               │   │
│  │  │   15     │ │  1,234   │ │    42    │ │    56    │               │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  🔍 Search Bar                                                      │   │
│  │  ┌────────────────────────────────────────┐  ┌─────────┐           │   │
│  │  │  Search memories...                   │  │  Search │           │   │
│  │  └────────────────────────────────────────┘  └─────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  📑 Tabs: [Observations] [Memories]                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  📋 Content List                                                    │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │ 🏷️ tool_use    │ 2025-02-21 10:30 │ ReadFile │ main.py       │ │   │
│  │  ├───────────────────────────────────────────────────────────────┤ │   │
│  │  │ 🏷️ shell       │ 2025-02-21 10:31 │ Shell    │ pip install   │ │   │
│  │  ├───────────────────────────────────────────────────────────────┤ │   │
│  │  │ 🏷️ file_op     │ 2025-02-21 10:32 │ N/A      │ config.json   │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                              ...                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  📄 Detail Modal (Click to view)                                    │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  Record #123                                    [X]         │   │   │
│  │  │ ─────────────────────────────────────────────────────────   │   │   │
│  │  │  Time: 2025-02-21T10:30:00                                  │   │   │
│  │  │  Type: tool_use                                             │   │   │
│  │  │  Tool: ReadFile                                             │   │   │
│  │  │                                                             │   │   │
│  │  │  Input:                                                     │   │   │
│  │  │  ```json                                                    │   │   │
│  │  │  {"path": "main.py"}                                        │   │   │
│  │  │  ```                                                        │   │   │
│  │  │                                                             │   │   │
│  │  │  Output:                                                    │   │   │
│  │  │  ```python                                                  │   │   │
│  │  │  def main():                                                │   │   │
│  │  │      print("Hello")                                         │   │   │
│  │  │  ```                                                        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Obsidian 集成架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        🔮 Obsidian 集成                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Kimi-Mem                    MCP Protocol                 Obsidian         │
│   ─────────                   ────────────                 ────────         │
│                                                                             │
│   ┌─────────────┐            ┌─────────────┐            ┌─────────────┐    │
│   │ 保存记忆     │───────────▶│ obsidian_   │───────────▶│ 接收文件     │    │
│   │             │   Stdio    │ append_     │  本地进程   │             │    │
│   │             │◀───────────│ content     │◀───────────│             │    │
│   └─────────────┘            └─────────────┘            └──────┬──────┘    │
│                                                                │            │
│                                                                ▼            │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                     📁 Obsidian Vault                              │  │
│   │  ┌─────────────────────────────────────────────────────────────┐   │  │
│   │  │ 📄 kimi-mem/index.md                                        │   │  │
│   │  │ ─────────────────────────────────────────────────────────   │   │  │
│   │  │ # Kimi-Mem Vault 索引                                       │   │  │
│   │  │                                                              │   │  │
│   │  │ ## 统计                                                      │   │  │
│   │  │ - 会话记录: 15 个                                           │   │  │
│   │  │ - 手动记忆: 42 个                                           │   │  │
│   │  │                                                              │   │  │
│   │  │ ## 快速导航                                                  │   │  │
│   │  │ - [[21-session-abc]]                                        │   │  │
│   │  │ - [[Python-装饰器]]                                          │   │  │
│   │  └─────────────────────────────────────────────────────────────┘   │  │
│   │                                                                     │  │
│   │  📁 kimi-mem/sessions/2025/02/21-session-abc.md                     │  │
│   │  📁 kimi-mem/memories/learning/Python-装饰器.md                      │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   💡 特性:                                                                  │
│   • 双向链接 [[...]] 自动创建                                               │
│   • Graph View 可视化知识图谱                                               │
│   • Dataview 查询支持                                                       │
│   • 全文搜索                                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 技术栈

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          🛠️ 技术栈                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  语言 & 运行时              存储                 协议 & 接口                  │
│  ───────────────            ─────               ────────────                 │
│                                                                             │
│  🐍 Python 3.10+           🗄️ SQLite 3          🔌 MCP (Stdio)              │
│  📦 mcp (官方 SDK)         🔍 FTS5 全文搜索      🌐 HTTP/REST               │
│  🧵 threading              📝 Markdown           📡 WebSocket (预留)        │
│                                                                             │
│  前端 (Web UI)             外部集成                                        │
│  ─────────────             ───────                                        │
│                                                                             │
│  📄 HTML5                  🔮 Obsidian (via MCP)                          │
│  🎨 CSS3 (Dark Theme)      🤖 Kimi Code CLI                               │
│  ⚡ Vanilla JS                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 性能指标

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          📊 性能指标                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  存储能力                      查询性能                                     │
│  ─────────                     ────────                                     │
│                                                                             │
│  • SQLite: 100,000+ 记录       • 全文搜索: <100ms (10万记录)               │
│  • Markdown: 10,000+ 文件      • 索引查询: <50ms                           │
│  • 单条记录: 最大 10KB         • 时间线查询: <30ms                         │
│                                                                             │
│  资源占用                                                                   │
│  ────────                                                                   │
│                                                                             │
│  • 内存: ~50MB (基础)                                                      │
│  • CPU: <1% (空闲)                                                         │
│  • 磁盘: 增长取决于记录数量                                                   │
│    - 基础: ~1MB                                                            │
│    - 每 1000 条记录: ~10MB                                                  │
│                                                                             │
│  Token 效率 (vs 直接传输)                                                   │
│  ────────────────────────                                                   │
│                                                                             │
│  渐进式披露: ████████████████████░░░░░░░░  节省 ~70%                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

<p align="center">
  📚 更多详情请参阅 <a href="README.md">README.md</a> 和 <a href="QUICKSTART.md">QUICKSTART.md</a>
</p>
